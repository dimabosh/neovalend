name: Deploy Aave V3.5 CORE Protocol (6 Phases)

permissions:
  contents: write

concurrency:
  group: neovalend-core-deploy-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      phase:
        description: 'CORE Deployment Phase'
        required: true
        default: 'core-1'
        type: choice
        options:
          - 'core-1'      # Math Libraries (5 contracts)
          - 'core-2'      # PoolAddressesProvider + ACL Admin
          - 'core-2.1'    # ACLManager, Oracle, InterestRateStrategy
          - 'core-2.2'    # Logic Libraries (8 contracts)
          - 'core-3'      # Pool Implementation + Pool Proxy Creation
          - 'core-3.1'    # PoolConfigurator Implementation + Proxy Creation
          - 'core-3.2'    # Deploy Test Tokens (NEO, USDT, USDC, BTC, ETH)
          - 'core-4'      # Token Implementation (2 contracts)
          - 'core-5'      # Data Providers & Gateways (4 contracts)
          - 'core-5.1'    # Grant Admin Roles (REQUIRED before Phase 6)
          - 'core-6'      # Protocol Configuration (PoolConfigurator setup & reserves)
          - 'hotfix-collateral' # HOTFIX: Configure wA7A5 collateral (one-time fix)
          - 'hotfix-oracle'     # HOTFIX: Configure Oracle price sources (REQUIRED for getUserAccountData)
          - 'hotfix-v3'         # HOTFIX V3: Add WBTC + Fix USDT collateral (comprehensive)
          - 'faucet'            # Get test tokens (USDT, wA7A5, WBTC)
          - 'verify-only' # Verify all contracts
          - 'status'      # Show deployment status
      network:
        description: 'Network to deploy to'
        required: true
        default: 'neox-testnet'
        type: choice
        options:
          - neox-testnet
          - neox-mainnet
          - sepolia
          - mainnet
      force_redeploy:
        description: 'Force redeploy all contracts (skip smart mode)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  SOLC_VERSION: '0.8.27'
  NODE_VERSION: '20'
  # NEO X Network Configuration
  NEOX_TESTNET_RPC: 'https://neoxt4seed1.ngd.network/'
  NEOX_MAINNET_RPC: 'https://mainnet-1.rpc.banelabs.org/'
  NEOX_TESTNET_CHAIN_ID: '12227332'
  NEOX_MAINNET_CHAIN_ID: '47763'

jobs:
  show-info:
    runs-on: ubuntu-latest
    steps:
      - name: Show Deployment Info
        run: |
          echo "ğŸš€ CORE Aave v3.5 Deployment"
          echo "=============================="
          echo "Phase: ${{ github.event.inputs.phase }}"
          echo "Network: ${{ github.event.inputs.network }}"
          echo ""
          echo "ğŸ“‹ CORE Protocol Features:"
          echo "âœ… Lending/Borrowing"
          echo "âœ… Multi-collateral"
          echo "âœ… Liquidations"
          echo "âœ… Flash Loans"
          echo "âœ… Variable Interest Rates"
          echo "âœ… Price Oracles"
          echo ""
          echo "ğŸ’° Total Cost: ~$3 USD (15 contracts)"

  # CORE Phase 1: Math Libraries
  core-phase-1:
    if: github.event.inputs.phase == 'core-1'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy CORE Phase 1 - Math Libraries
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && env.NEOX_TESTNET_RPC || github.event.inputs.network == 'neox-mainnet' && env.NEOX_MAINNET_RPC || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 1: Math Libraries"
          echo "ğŸŒ Network: ${{ github.event.inputs.network }}"
          echo "ğŸ’° Cost: ~$0.5 USD | 5 contracts"
          echo "ğŸ“‹ WadRayMath, PercentageMath, MathUtils, Errors, DataTypes"
          echo ""
          node scripts/deploy/core-phase1-math.js
      
      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 1: Math Libraries deployed" || exit 0
          git push

  # CORE Phase 2: PoolAddressesProvider + ACL Admin
  core-phase-2:
    if: github.event.inputs.phase == 'core-2'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy CORE Phase 2 - PoolAddressesProvider
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 2: PoolAddressesProvider + ACL Admin"
          echo "ğŸ’° Cost: ~$0.1 USD | 1 contract"
          echo "ğŸ“‹ Main registry contract for Aave v3.5 protocol"
          echo ""
          node scripts/deploy/core-phase2-addresses-provider.js

      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 2: PoolAddressesProvider deployed" || exit 0
          git push

  # CORE Phase 2.1: ACLManager, Oracle, InterestRateStrategy
  core-phase-2_1:
    if: github.event.inputs.phase == 'core-2.1'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0
          # OpenZeppelin 5.1.0 already installed above

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy Phase 2.1 - Infrastructure
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 2.1: ACLManager, Oracle, InterestRateStrategy"
          echo "ğŸ’° Cost: ~$0.7 USD | 3 contracts"
          echo "ğŸ“‹ Infrastructure contracts for protocol"
          echo ""
          node scripts/deploy/core-phase2_1-infrastructure.js

      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 2.1: Infrastructure deployed" || exit 0
          git push

  # CORE Phase 2.2: Logic Libraries
  core-phase-2_2:
    if: github.event.inputs.phase == 'core-2.2'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0

      - name: Deploy CORE Phase 2.2 - Logic Libraries
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 2.2: Logic Libraries"
          echo "ğŸ’° Cost: ~$2.0 USD | 8 libraries"
          echo "ğŸ“‹ ReserveLogic, SupplyLogic, BorrowLogic, FlashLoanLogic, etc."
          echo ""
          node scripts/deploy/core-phase2_2-logic-libraries.js

      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 2.2: Logic Libraries deployed" || exit 0
          git push

  # CORE Phase 3: Pool Implementation
  core-phase-3:
    if: github.event.inputs.phase == 'core-3'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy CORE Phase 3 - Pool Implementation
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 3: Pool Implementation (with Flash Loans!)"
          echo "ğŸ’° Cost: ~$1.2 USD | 3 contracts"
          echo "ğŸ“‹ Pool, PoolConfigurator, ProtocolDataProvider"
          echo ""
          node scripts/deploy/core-phase3-pool.js
      
      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 3: Pool Implementation with Flash Loans deployed" || exit 0
          git push

  # CORE Phase 3.1: PoolConfigurator Implementation + Proxy
  core-phase-3_1:
    if: github.event.inputs.phase == 'core-3.1'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0

      - name: Deploy PoolConfigurator Implementation + Create Proxy
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          NETWORK: ${{ github.event.inputs.network }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
        run: |
          echo "ğŸš€ CORE Phase 3.1: PoolConfigurator Implementation + Proxy"
          echo "=========================================================="
          echo "ğŸ“‹ Deploying PoolConfigurator Implementation"
          echo "ğŸ“‹ Creating PoolConfigurator Proxy"
          echo "âš ï¸  REQUIREMENT: Pool proxy must exist (Phase 3)"
          node scripts/deploy/core-phase3_1-configurator.js

      - name: Commit deployment updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 3.1: PoolConfigurator Implementation + Proxy deployed" || exit 0
          git push

  # CORE Phase 4: Token Implementation
  core-phase-4:
    if: github.event.inputs.phase == 'core-4'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
          
      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0
      
      - name: Deploy CORE Phase 4 - Token Implementation
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          NETWORK: ${{ github.event.inputs.network }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
        run: |
          echo "ğŸš€ CORE Phase 4: Token Implementation"
          echo "ğŸ’° Cost: ~$0.4 USD | 2 contracts"
          echo "ğŸ“‹ AToken, VariableDebtToken"
          echo ""
          node scripts/deploy/core-phase4-tokens.js
      
      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 4: Token Implementation deployed" || exit 0
          git push

  # CORE Phase 3.2: Deploy wA7A5 Token
  core-phase-3_2:
    if: github.event.inputs.phase == 'core-3.2'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0

      - name: Deploy Test Tokens (NEO, USDT, USDC, BTC, ETH)
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          NETWORK: ${{ github.event.inputs.network }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
        run: |
          echo "ğŸš€ CORE Phase 3.2: Deploy Test Tokens"
          echo "=========================================="
          echo "ğŸ“‹ 5 Test Tokens: NEO, USDT, USDC, BTC, ETH"
          echo "ğŸ“‹ NEO/USDT/USDC: 100M supply"
          echo "ğŸ“‹ BTC/ETH: 10M supply"
          echo ""
          node scripts/deploy/core-phase3_2-test-tokens.js

      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 3.2: Test tokens deployed (NEO, USDT, USDC, BTC, ETH)" || exit 0
          git push

  # CORE Phase 5: Proxy & Finalization
  core-phase-5:
    if: github.event.inputs.phase == 'core-5'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0
          npm install @openzeppelin/contracts-upgradeable@5.1.0
          # OpenZeppelin 5.1.0 already installed above
      
      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      
      - name: Deploy CORE Phase 5 - Proxy & Finalization
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 5: Proxy & Finalization"
          echo "ğŸ’° Cost: ~$0.1 USD | 1 contract"
          echo "ğŸ“‹ UpgradeabilityProxy"
          echo "ğŸ‰ CORE Protocol Complete!"
          echo ""
          node scripts/deploy/core-phase5-proxy.js
      
      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ“ CORE Phase 5: Data Providers & Gateways deployed" || exit 0
          git push

  # CORE Phase 5.1: Grant Admin Roles
  core-phase-5_1:
    if: github.event.inputs.phase == 'core-5.1'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - run: npm install

      - name: Install ethers
        run: npm install ethers@6

      - name: Grant Admin Roles
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸ” CORE Phase 5.1: Grant Admin Roles"
          echo "ğŸ’° Cost: ~$0.05 USD | 2 transactions"
          echo "ğŸ“‹ POOL_ADMIN + ASSET_LISTING_ADMIN roles"
          echo ""
          node scripts/deploy/core-phase5_1-grant-roles.js

      - name: Commit results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/ || true
          git commit -m "ğŸ” CORE Phase 5.1: Admin roles granted" || exit 0
          git push

  # CORE Phase 6: Protocol Configuration
  core-phase-6:
    if: github.event.inputs.phase == 'core-6'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry (for cast commands)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6

      - name: Configure Protocol - CORE Phase 6
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ CORE Phase 6: Protocol Configuration"
          echo "ğŸ’° Cost: ~$2.5 USD | Configuration tasks"
          echo "ğŸ“‹ Register PoolConfigurator + Initialize Reserves"
          echo ""
          node scripts/deploy/core-phase6-configuration.js

      - name: Commit configuration results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸ‰ CORE Phase 6: Protocol Configuration Complete! Neovalend Protocol READY ğŸš€" || exit 0
          git push

  # HOTFIX: Configure wA7A5 Collateral (one-time fix for Phase 6 issue)
  hotfix-collateral:
    if: github.event.inputs.phase == 'hotfix-collateral'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry (for cast commands)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6

      - name: Hotfix - Configure wA7A5 Collateral
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸ”§ HOTFIX: Configure wA7A5 Collateral"
          echo "ğŸ’° Cost: ~$0.05 USD | 1 transaction"
          echo ""
          echo "ğŸ“‹ Issue: Phase 6 used wrong function signature (5 params instead of 4)"
          echo "ğŸ¯ Fix: Configure wA7A5 as collateral with correct signature"
          echo "âœ… Result: LTV=50%, Liquidation Threshold=60%, Bonus=10%"
          echo ""
          echo "âš ï¸ Note: This is a ONE-TIME fix. Phase 6 code already corrected for future deploys."
          echo ""
          node scripts/deploy/hotfix-wa7a5-collateral.js

      - name: Commit hotfix results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/ || true
          git commit -m "ğŸ”§ HOTFIX: wA7A5 collateral configured (LTV=50%) âœ…" || exit 0
          git push

  # HOTFIX: Configure Oracle Price Sources (CRITICAL for getUserAccountData)
  hotfix-oracle:
    if: github.event.inputs.phase == 'hotfix-oracle'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry (for forge create and cast commands)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6

      - name: Hotfix - Configure Oracle Price Sources
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸ”§ HOTFIX: Configure Oracle Price Sources"
          echo "ğŸ’° Cost: ~$0.50 USD | 4 transactions (2 deploys + 2 setPrice + 1 setAssetSources)"
          echo ""
          echo "ğŸ“‹ Issue: AaveOracle deployed without price sources in Phase 2"
          echo "ğŸ” Symptom: getUserAccountData reverts with 'call to non-contract address 0x0'"
          echo "ğŸ¯ Fix: Deploy SimplePriceOracle for each asset + set sources in AaveOracle"
          echo ""
          echo "ğŸ’° Prices:"
          echo "  - USDT: \$1.00 (100000000 in 8 decimals)"
          echo "  - wA7A5: \$0.0111 (1111111 in 8 decimals) // 1 USDT = 90 A7A5"
          echo ""
          echo "âœ… Result: getUserAccountData will work correctly"
          echo ""
          echo "âš ï¸ Note: This is a ONE-TIME fix. Future deploys should include Oracle config in Phase 2 or Phase 6."
          echo ""
          node scripts/deploy/hotfix-oracle-prices.js

      - name: Commit hotfix results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/ || true
          git commit -m "ğŸ”§ HOTFIX: Oracle price sources configured (USDT=\$1.00, wA7A5=\$0.0111) âœ…" || exit 0
          git push

  # HOTFIX V3: Add WBTC + Fix USDT Collateral (comprehensive)
  hotfix-v3:
    if: github.event.inputs.phase == 'hotfix-v3'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Foundry (for forge create and cast commands)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6

      - name: Hotfix V3 - Add WBTC + Fix USDT Collateral
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš€ HOTFIX V3: Add WBTC + Configure USDT as Collateral"
          echo "ğŸ’° Cost: ~$1.50 USD | Comprehensive protocol update"
          echo ""
          echo "ğŸ“‹ PART 1: Fix USDT Collateral"
          echo "  - Unpause USDT reserve"
          echo "  - Configure collateral parameters (LTV=80%, LT=82.5%, Bonus=5%)"
          echo ""
          echo "ğŸ“‹ PART 2: Add WBTC Support"
          echo "  - Deploy SimplePriceOracle for WBTC"
          echo "  - Set WBTC price to \$120,000"
          echo "  - Initialize WBTC reserve (rWBTC aToken)"
          echo "  - Configure WBTC collateral (LTV=70%, LT=75%, Bonus=10%)"
          echo "  - Set interest rates (base=0%, slope1=4%, slope2=300%)"
          echo "  - Enable WBTC borrowing"
          echo ""
          echo "âœ… Result: 3 fully functional assets (USDT, wA7A5, WBTC)"
          echo ""
          node scripts/hotfix-v3-add-wbtc.js

      - name: Commit hotfix V3 results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/ || true
          git commit -m "ğŸš€ HOTFIX V3: Added WBTC + Fixed USDT collateral âœ…" || exit 0
          git push

  # Phase Faucet: Deploy Faucet Contract for Token Distribution
  faucet:
    if: github.event.inputs.phase == 'faucet'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npm install ethers@6 solc@${{ env.SOLC_VERSION }}
          npm install @openzeppelin/contracts@5.1.0

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy Faucet Contract
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          RPC_URL_SEPOLIA: ${{ github.event.inputs.network == 'neox-testnet' && 'https://neoxt4seed1.ngd.network/' || github.event.inputs.network == 'neox-mainnet' && 'https://mainnet-1.rpc.banelabs.org/' || github.event.inputs.network == 'sepolia' && secrets.RPC_URL_SEPOLIA || secrets.RPC_URL_SEPOLIA }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FOUNDRY_DISABLE_NIGHTLY_WARNING: true
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          NETWORK: ${{ github.event.inputs.network }}
        run: |
          echo "ğŸš° Phase Faucet: Deploy Testnet Faucet Contract"
          echo "ğŸ’° Cost: ~$0.2 USD | 1 contract"
          echo "ğŸ“‹ Features: Token distribution with 24h cooldown"
          echo ""
          node scripts/deploy/phase-faucet.js

      - name: Commit Faucet deployment results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add deployments/
          git commit -m "ğŸš° Phase Faucet: Deployed Faucet contract âœ…" || exit 0
          git push

      - name: Summary
        run: |
          echo "## ğŸš° Faucet Contract Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 24-hour cooldown per token per user" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Distributes USDT (1,000), wA7A5 (100,000), WBTC (0.1)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Owner-controlled amounts and cooldown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Transfer tokens to Faucet contract address" >> $GITHUB_STEP_SUMMARY
          echo "2. Update frontend to use Faucet contract" >> $GITHUB_STEP_SUMMARY
          echo "3. Users can request tokens via requestUSDT(), requestWA7A5(), requestWBTC()" >> $GITHUB_STEP_SUMMARY

  # Show deployment status
  status:
    if: github.event.inputs.phase == 'status'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Deployment Status
        run: |
          echo "ğŸ“Š CORE Deployment Status"
          echo "========================"
          if [ -f "deployments/all-contracts.json" ]; then
            echo "ğŸ“„ Reading deployments/all-contracts.json..."
            cat deployments/all-contracts.json | jq '.'
          else
            echo "âŒ No deployments found. Run core-1 first."
          fi